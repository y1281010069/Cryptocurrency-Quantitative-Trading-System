{% extends "layout.html" %}

{% block title %}设置最大杠杆 - 加密货币量化交易系统{% endblock %}

{% block page_title %}设置最大杠杆{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 md:mb-0">设置最大杠杆</h3>
        <div class="flex space-x-4">
            <button id="set-leverage-btn" class="bg-primary hover:bg-secondary text-white px-6 py-3 rounded-lg shadow transition duration-300 flex items-center">
                <i class="fa fa-bolt mr-2"></i>
                <span>执行设置杠杆</span>
            </button>
            <button id="set-max-leverage-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow transition duration-300 flex items-center">
                <i class="fa fa-rocket mr-2"></i>
                <span>一键设置最大杠杆</span>
            </button>
        </div>
    </div>
    
    <div id="status-message" class="hidden p-4 rounded-lg mb-4"></div>
    
    <!-- 杠杆设置和交易对选择 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
            <h4 class="font-medium text-gray-700 mb-3">杠杆设置</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="leverageInput" class="block text-sm font-medium text-gray-600 mb-1">杠杆倍数:</label>
                    <input type="number" id="leverageInput" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary" min="1" max="100" step="1" value="10">
                </div>
                <div>
                    <label for="mgnModeSelect" class="block text-sm font-medium text-gray-600 mb-1">保证金模式:</label>
                    <select id="mgnModeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="isolated">逐仓</option>
                        <option value="cross">全仓</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 交易对选择 -->
    <div class="mb-6">
        <h4 class="font-medium text-gray-700 mb-3">交易对选择:</h4>
        <div class="border border-gray-200 rounded-lg p-4 max-h-60 overflow-y-auto">
            <!-- 全选按钮 -->
            <div class="mb-3">
                <label class="flex items-center">
                    <input type="checkbox" id="select-all-symbols" class="h-4 w-4 text-primary border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">全选</span>
                </label>
            </div>
            
            <!-- 交易对列表 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2" id="symbols-container">
                {% if symbols %}
                    {% for symbol in symbols %}
                        <label class="flex items-center">
                            <input type="checkbox" class="symbol-checkbox h-4 w-4 text-primary border-gray-300 rounded" value="{{ symbol.symbol }}">
                            <span class="ml-2 text-sm text-gray-700">{{ symbol.symbol }} {% if symbol.max_leverage %}(最大{{ symbol.max_leverage }}x){% endif %}</span>
                        </label>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500">暂无可用交易对</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="overflow-hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-700 mb-2">总交易对</h4>
                <p id="total-instruments" class="text-2xl font-semibold text-primary">0</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-700 mb-2">设置成功</h4>
                <p id="success-count" class="text-2xl font-semibold text-green-600">0</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="font-medium text-gray-700 mb-2">设置失败</h4>
                <p id="failed-count" class="text-2xl font-semibold text-red-600">0</p>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="relative">
                <div id="progress-bar" class="absolute top-0 left-0 h-full bg-primary/20 rounded-lg transition-all duration-300" style="width: 0%"></div>
                <div class="relative p-3 flex justify-between items-center">
                    <span id="progress-text" class="font-medium text-gray-700">准备就绪</span>
                    <span id="progress-percentage" class="text-sm text-gray-500">0%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">执行日志</h3>
    <div id="execution-log" class="bg-gray-50 p-4 rounded-lg h-80 overflow-y-auto font-mono text-sm text-gray-700"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
        document.addEventListener('DOMContentLoaded', function() {
            const setLeverageBtn = document.getElementById('set-leverage-btn');
            const statusMessage = document.getElementById('status-message');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            const executionLog = document.getElementById('execution-log');
            const totalInstrumentsEl = document.getElementById('total-instruments');
            const successCountEl = document.getElementById('success-count');
            const failedCountEl = document.getElementById('failed-count');
            
            let isProcessing = false;
            
            // 添加日志函数
            function addLog(message, isError = false) {
                const logEntry = document.createElement('div');
                logEntry.className = isError ? 'text-red-600' : 'text-gray-700';
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                executionLog.appendChild(logEntry);
                executionLog.scrollTop = executionLog.scrollHeight;
            }
            
            // 显示状态消息
            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.className = `p-4 rounded-lg mb-4 ${isError ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'}`;
                statusMessage.classList.remove('hidden');
            }
            
            // 隐藏状态消息
            function hideStatus() {
                statusMessage.classList.add('hidden');
            }
            
            // 更新进度
            function updateProgress(percentage, text) {
                progressBar.style.width = `${percentage}%`;
                progressPercentage.textContent = `${percentage}%`;
                progressText.textContent = text;
            }
            
            // 全选/取消全选功能
            document.getElementById('select-all-symbols').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.symbol-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });
            
            // 执行设置杠杆
            setLeverageBtn.addEventListener('click', async function() {
                if (isProcessing) return;
                
                // 获取选中的交易对
                const selectedSymbols = Array.from(document.querySelectorAll('.symbol-checkbox:checked'))
                    .map(checkbox => checkbox.value);
                
                if (selectedSymbols.length === 0) {
                    showStatus('请至少选择一个交易对', true);
                    return;
                }
                
                isProcessing = true;
                setLeverageBtn.disabled = true;
                setLeverageBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i><span>处理中...</span>';
                
                hideStatus();
                executionLog.innerHTML = '';
                updateProgress(0, '准备中...');
                
                try {
                    // 构建请求数据
                    const leverageInput = document.getElementById('leverageInput');
                    const mgnModeSelect = document.getElementById('mgnModeSelect');
                    
                    const requestData = {
                        symbols: selectedSymbols,
                        leverage: parseInt(leverageInput.value, 10) || 1,
                        mgn_mode: mgnModeSelect.value || 'isolated'
                    };
                    
                    addLog('开始执行设置最大杠杆操作');
                    addLog(`请求参数: ${JSON.stringify(requestData)}`);
                    
                    // 调用API执行设置最大杠杆
                    const response = await fetch('/api/set_max_leverage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API调用失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API响应:', data);
                    
                    if (data.status === 'success' || data.success) {
                        showStatus('设置最大杠杆操作已成功完成');
                        addLog('设置最大杠杆操作已完成');
                        
                        // 更新统计信息
                        totalInstrumentsEl.textContent = data.details?.total || data.total || 0;
                        successCountEl.textContent = data.details?.success_count || data.successCount || 0;
                        failedCountEl.textContent = data.details?.fail_count || data.failedCount || 0;
                        
                        // 添加详细日志
                        if (data.details?.results && Array.isArray(data.details.results)) {
                            data.details.results.forEach(item => {
                                addLog(`交易对 ${item.symbol}: ${item.message}`, !item.success);
                            });
                        } else if (data.logs && Array.isArray(data.logs)) {
                            data.logs.forEach(log => {
                                addLog(log.message, log.error);
                            });
                        }
                        
                        updateProgress(100, '完成');
                    } else {
                        throw new Error(data.message || '设置最大杠杆操作失败');
                    }
                } catch (error) {
                    showStatus(`操作失败: ${error.message}`, true);
                    addLog(`错误: ${error.message}`, true);
                    updateProgress(0, '操作失败');
                    console.error('API请求错误:', error);
                } finally {
                    isProcessing = false;
                    setLeverageBtn.disabled = false;
                    setLeverageBtn.innerHTML = '<i class="fa fa-bolt mr-2"></i><span>执行设置最大杠杆</span>';
                }
            });

            // 一键设置最大杠杆
            document.getElementById('set-max-leverage-btn').addEventListener('click', async function() {
                if (isProcessing) return;
                
                // 自动选择所有交易对
                document.getElementById('select-all-symbols').checked = true;
                document.querySelectorAll('.symbol-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                // 获取所有交易对
                const selectedSymbols = Array.from(document.querySelectorAll('.symbol-checkbox:checked'))
                    .map(checkbox => checkbox.value);
                
                if (selectedSymbols.length === 0) {
                    showStatus('请至少选择一个交易对', true);
                    return;
                }
                
                isProcessing = true;
                document.getElementById('set-max-leverage-btn').disabled = true;
                document.getElementById('set-max-leverage-btn').innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i><span>处理中...</span>';
                setLeverageBtn.disabled = true;
                
                hideStatus();
                executionLog.innerHTML = '';
                updateProgress(0, '准备中...');
                
                try {
                    // 获取保证金模式
                    const mgnModeSelect = document.getElementById('mgnModeSelect');
                    
                    addLog('开始执行一键设置最大杠杆操作');
                    addLog(`将为 ${selectedSymbols.length} 个交易对设置最大杠杆`);
                    addLog(`保证金模式: ${mgnModeSelect.value}`);
                    
                    // 调用API执行设置最大杠杆
                    const response = await fetch('/api/set_all_max_leverage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mgn_mode: mgnModeSelect.value || 'isolated'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API调用失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API响应:', data);
                    
                    if (data.status === 'success' || data.success) {
                        showStatus('一键设置最大杠杆操作已成功完成');
                        addLog('一键设置最大杠杆操作已完成');
                        
                        // 更新统计信息
                        totalInstrumentsEl.textContent = data.details?.total || data.total || 0;
                        successCountEl.textContent = data.details?.success_count || data.successCount || 0;
                        failedCountEl.textContent = data.details?.fail_count || data.failedCount || 0;
                        
                        // 添加详细日志
                        if (data.details?.results && Array.isArray(data.details.results)) {
                            data.details.results.forEach(item => {
                                addLog(`交易对 ${item.symbol}: 设置为 ${item.max_leverage}x - ${item.message}`, !item.success);
                            });
                        } else if (data.logs && Array.isArray(data.logs)) {
                            data.logs.forEach(log => {
                                addLog(log.message, log.error);
                            });
                        }
                        
                        updateProgress(100, '完成');
                    } else {
                        throw new Error(data.message || '一键设置最大杠杆操作失败');
                    }
                } catch (error) {
                    showStatus(`操作失败: ${error.message}`, true);
                    addLog(`错误: ${error.message}`, true);
                    updateProgress(0, '操作失败');
                    console.error('API请求错误:', error);
                } finally {
                    isProcessing = false;
                    document.getElementById('set-max-leverage-btn').disabled = false;
                    document.getElementById('set-max-leverage-btn').innerHTML = '<i class="fa fa-rocket mr-2"></i><span>一键设置最大杠杆</span>';
                    setLeverageBtn.disabled = false;
                }
            });
        });
    </script>
{% endblock %}